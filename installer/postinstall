#!/bin/bash
# Post-install script for DrumEngine01 presets and samples
# This script moves presets and samples from temp to the selected installation location

set -e

# $2 is the target location (where the package is being installed)
# When user selects a custom location, $2 is like /Users/username
INSTALL_ROOT="$2"

# Get the actual user (not root, even if running with sudo)
if [ -n "$USER" ] && [ "$USER" != "root" ]; then
    ACTUAL_USER="$USER"
elif [ -n "$SUDO_USER" ]; then
    ACTUAL_USER="$SUDO_USER"
else
    ACTUAL_USER=$(stat -f '%Su' "$INSTALL_ROOT")
fi

# Determine destination directory
if [ "$INSTALL_ROOT" = "/" ] || [ -z "$INSTALL_ROOT" ]; then
    # System-wide install - use current user's home
    USER_HOME=$(eval echo ~$ACTUAL_USER)
    DEST_DIR="$USER_HOME/Documents/DrumEngine01"
elif [[ "$INSTALL_ROOT" == /Users/* ]]; then
    # User selected a home directory like /Users/marian
    # Install to Documents/DrumEngine01 within that user's home
    DEST_DIR="$INSTALL_ROOT/Documents/DrumEngine01"
else
    # User selected a custom non-home path like /Hello/Yoyo
    # Install directly to DrumEngine01 within that path
    DEST_DIR="$INSTALL_ROOT/DrumEngine01"
fi

echo "Installing DrumEngine01 presets and samples..."
echo "Installation root: $INSTALL_ROOT"
echo "Destination: $DEST_DIR"
echo "User: $ACTUAL_USER"

# Create destination directories
mkdir -p "$DEST_DIR/presets"
mkdir -p "$DEST_DIR/samples"

# Source files are always in /tmp (absolute path)
# The package installs to /tmp/DrumEngine01_install/ regardless of target
SOURCE_DIR="/tmp/DrumEngine01_install"

# Copy presets
if [ -d "$SOURCE_DIR/presets" ]; then
    echo "Copying presets..."
    cp -R "$SOURCE_DIR/presets/"* "$DEST_DIR/presets/" 2>/dev/null || true
    echo "✓ Presets installed"
fi

# Copy samples
if [ -d "$SOURCE_DIR/samples" ]; then
    echo "Copying samples..."
    cp -R "$SOURCE_DIR/samples/"* "$DEST_DIR/samples/" 2>/dev/null || true
    echo "✓ Samples installed"
fi

# Clean up temp files
rm -rf "$SOURCE_DIR" 2>/dev/null || true

# Set proper permissions
chmod -R 755 "$DEST_DIR" 2>/dev/null || true
if [ "$ACTUAL_USER" != "root" ]; then
    chown -R "$ACTUAL_USER" "$DEST_DIR" 2>/dev/null || true
fi

echo "✓ Installation complete!"
echo ""
echo "DrumEngine01 data installed to: $DEST_DIR"

exit 0
