#!/bin/bash
# Post-install script for DrumEngine01 presets
# This script moves presets from temp to the selected installation location

set -e

# $2 is the target location (where the package is being installed)
# When user selects a custom location, $2 is like /Users/username
INSTALL_ROOT="$2"

# Installer may pass the staging path as the target; normalize to system root
if [[ "$INSTALL_ROOT" == /tmp/DrumEngine01_install* ]]; then
    INSTALL_ROOT="/"
fi

# Log to a temp file for troubleshooting
LOG_FILE="/tmp/DrumEngine01_postinstall.log"
{
    echo ""
    echo "==== DrumEngine01 postinstall $(date) ===="
    echo "Install root: $INSTALL_ROOT"
} >> "$LOG_FILE"
exec >> "$LOG_FILE" 2>&1

# Get the actual console user (not root, even if running with sudo)
if [ -n "$USER" ] && [ "$USER" != "root" ]; then
    ACTUAL_USER="$USER"
elif [ -n "$SUDO_USER" ]; then
    ACTUAL_USER="$SUDO_USER"
else
    ACTUAL_USER=$(stat -f '%Su' /dev/console 2>/dev/null || true)
fi

# No fallback: if console user cannot be determined, fail fast
if [ -z "$ACTUAL_USER" ] || [ "$ACTUAL_USER" = "root" ]; then
    echo "✗ Error: Could not determine a non-root console user for install."
    exit 1
fi

# Determine destination directory
if [ "$INSTALL_ROOT" = "/" ] || [ -z "$INSTALL_ROOT" ]; then
    # System-wide install - use current user's home
    USER_HOME=$(eval echo ~$ACTUAL_USER)
    DEST_DIR="$USER_HOME/Documents/DrumEngine01"
else
    # User-selected location becomes the root
    DEST_DIR="$INSTALL_ROOT"
fi

echo "Installing DrumEngine01 presets..."
echo "Installation root: $INSTALL_ROOT"
echo "Destination: $DEST_DIR"
echo "User: $ACTUAL_USER"

# Create destination directories
mkdir -p "$DEST_DIR"
FACTORY_DIR="$DEST_DIR/factory"

# Replace factory folder instead of appending
rm -rf "$FACTORY_DIR"
mkdir -p "$FACTORY_DIR"

# Source files are always in /tmp (absolute path)
# The package installs to /tmp/DrumEngine01_install/presets regardless of target
SOURCE_DIR="/tmp/DrumEngine01_install/presets"

# Copy presets into factory folder
if [ -d "$SOURCE_DIR" ]; then
    echo "Copying presets from $SOURCE_DIR to $FACTORY_DIR..."
    ditto "$SOURCE_DIR" "$FACTORY_DIR"
    echo "Verifying copy..."
    ls -la "$FACTORY_DIR" | head -n 50
    echo "✓ Presets installed"
else
    echo "✗ Error: Source presets not found at $SOURCE_DIR"
    exit 1
fi

# Copy factory content version marker
if [ -f "$SOURCE_DIR/version.txt" ]; then
    cp -f "$SOURCE_DIR/version.txt" "$FACTORY_DIR/version.txt"
    echo "✓ Factory content version: $(cat "$FACTORY_DIR/version.txt")"
fi

# Clean up temp files
rm -rf "$SOURCE_DIR" 2>/dev/null || true

# Set proper permissions
chmod -R 755 "$DEST_DIR" 2>/dev/null || true
if [ "$ACTUAL_USER" != "root" ]; then
    chown -R "$ACTUAL_USER" "$DEST_DIR" 2>/dev/null || true
fi

echo "✓ Installation complete!"
echo ""
echo "DrumEngine01 data installed to: $DEST_DIR"

exit 0
